// <auto-generated>
// This code was generated by GodotApplePlugins.Generator.
// Do not edit this file directly. Edit the generator instead.
// </auto-generated>

#nullable enable

using Godot;
using System;
using System.Linq;

namespace GodotApplePlugins.Sharp.StoreKit;

/// <summary>
/// Manages StoreKit interactions such as requesting products, purchasing, and restoring purchases.
/// </summary>
public partial class StoreKitManager
{
    private readonly GodotObject _instance;

    /// <summary>
    /// Creates a new StoreKitManager wrapper.
    /// </summary>
    public StoreKitManager(GodotObject instance)
    {
        _instance = instance ?? throw new ArgumentNullException(nameof(instance));
        ConnectSignals();
    }

    /// <summary>
    /// Gets the underlying GDExtension object.
    /// </summary>
    public GodotObject Instance => _instance;

    /// <summary>
    /// The current entitlements sequence provides the most recent transaction for each product the customer is entitled to, use this to refresh the list of features the user is entitled to. Specifically, it includes: * One transaction for each non-consumable In-App Purchase * The latest transaction for each auto-renewable subscription whose Product.SubscriptionInfo.RenewalState is either subscribed or inGracePeriod * The latest transaction for each non-renewing subscription, including those that have ended * Products that have been refunded or revoked by the App Store are excluded from the current entitlements, as are consumable In-App Purchases. To retrieve transactions for unfinished consumables, use the unfinished or all transaction sequences instead.
    /// </summary>
    public void FetchCurrentEntitlements()
    {
        _instance.Call(new StringName("fetch_current_entitlements"));
    }

    /// <summary>
    /// Initiates the purchase of a specific product, e.g. 'purchase(product)'. This will raise the purchase_completed signal, either to indicate that an error took place, or the status of the purchase.
    /// </summary>
    public void Purchase(StoreProduct product)
    {
        _instance.Call(new StringName("purchase"), product.Instance);
    }

    /// <summary>
    /// Initiates the purchase of a specific product, e.g. 'purchase(product)', and allows you to provide additional purchase options. This will raise the purchase_completed signal, either to indicate that an error took place, or the status of the purchase.
    /// </summary>
    public void PurchaseWithOptions(StoreProduct product, StoreProductPurchaseOption[] options)
    {
        _instance.Call(new StringName("purchase_with_options"), product.Instance, new Godot.Collections.Array(options.Select(x => x.Instance)));
    }

    /// <summary>
    /// Requests product information for a list of product identifiers, e.g. 'request_products(["com.example.product1", "com.example.product2"])'. This method will raise the products_request_completed signal when the information is retrieved.
    /// </summary>
    public void RequestProducts(string[] productids)
    {
        _instance.Call(new StringName("request_products"), productids);
    }

    /// <summary>
    /// Restores previously purchased non-consumable products and auto-renewable subscriptions. This will raise the restore_completed signal when the product purchased have been restored.
    /// </summary>
    public void RestorePurchases()
    {
        _instance.Call(new StringName("restore_purchases"));
    }

    #region Signals

    /// <summary>
    /// Emitted when a product request completes. products is an Array of StoreProducts (or nulls). status indicates success or failure.
    /// </summary>
    public event Action<StoreProduct[], int>? ProductsRequestCompleted;

    /// <summary>
    /// Emitted when a purchase completes. transaction is the StoreTransaction on success. status indicates the result (OK, cancelled, invalid product, etc.). error_message contains error details if failed.
    /// </summary>
    public event Action<StoreTransaction, int, string>? PurchaseCompleted;

    public event Action<StoreProduct>? PurchaseIntent;

    /// <summary>
    /// Emitted when the restore process completes. `arg1` is the StoreKitStatus, and `arg2` is an error message if applicable.
    /// </summary>
    public event Action<int, string>? RestoreCompleted;

    public event Action<StoreSubscriptionInfoStatus>? SupscriptionUpdate;

    /// <summary>
    /// Emitted when a transaction is updated (e.g., a subscription renews or a purchase is approved externally). `transaction` is the updated StoreTransaction. You must call the finished method on the transaction once you have made sure that you have delivered the content to the user.
    /// </summary>
    public event Action<StoreTransaction>? TransactionUpdated;

    public event Action<StoreTransaction, int>? UnverifiedTransactionUpdated;

    private void ConnectSignals()
    {
        _instance.Connect(new StringName("products_request_completed"),
            Callable.From<Godot.Collections.Array, int>((p0, p1) =>
                ProductsRequestCompleted?.Invoke(p0.Select(x => new StoreProduct((GodotObject)x.Obj!)).ToArray(), p1)));

        _instance.Connect(new StringName("purchase_completed"),
            Callable.From<GodotObject, int, string>((p0, p1, p2) =>
                PurchaseCompleted?.Invoke(new StoreTransaction(p0), p1, p2)));

        _instance.Connect(new StringName("purchase_intent"),
            Callable.From<GodotObject>((p0) =>
                PurchaseIntent?.Invoke(new StoreProduct(p0))));

        _instance.Connect(new StringName("restore_completed"),
            Callable.From<int, string>((p0, p1) =>
                RestoreCompleted?.Invoke(p0, p1)));

        _instance.Connect(new StringName("supscription_update"),
            Callable.From<GodotObject>((p0) =>
                SupscriptionUpdate?.Invoke(new StoreSubscriptionInfoStatus(p0))));

        _instance.Connect(new StringName("transaction_updated"),
            Callable.From<GodotObject>((p0) =>
                TransactionUpdated?.Invoke(new StoreTransaction(p0))));

        _instance.Connect(new StringName("unverified_transaction_updated"),
            Callable.From<GodotObject, int>((p0, p1) =>
                UnverifiedTransactionUpdated?.Invoke(new StoreTransaction(p0), p1)));

    }

    #endregion
}
